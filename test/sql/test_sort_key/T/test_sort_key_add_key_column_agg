-- name: test_sort_key_add_key_column_agg
create database test_agg_add_key_sort_${uuid0};
use test_agg_add_key_sort_${uuid0};

CREATE TABLE `agg_t` (
    `k1` int NOT NULL,
    `k2` int NOT NULL,
    `v1` bigint SUM DEFAULT '0',
    `v2` bigint SUM DEFAULT '0'
)
AGGREGATE KEY(k1, k2)
DISTRIBUTED BY HASH(`k1`) BUCKETS 1
ORDER BY(k2, k1)
PROPERTIES ("replication_num" = "1");

insert into agg_t values (1, 3, 10, 20), (2, 1, 30, 40), (3, 2, 50, 60);
select * from agg_t order by k1;

-- Add key column at default position (last key)
alter table agg_t add column k3 int default '0';
function: wait_alter_table_finish()
select * from agg_t order by k1;
insert into agg_t values (4, 4, 70, 80, 1);
select * from agg_t order by k1;
insert into agg_t values (1, 3, 0, 5, 5), (2, 1, 0, 10, 10);
select * from agg_t order by k1;
select k1, k2, v1, v2 from agg_t where k1 in (1, 2) order by k1;

-- Add key column at middle position (AFTER k1)
alter table agg_t add column k4 int default '0' after k1;
function: wait_alter_table_finish()
select * from agg_t order by k1;
insert into agg_t values (5, 2, 90, 100, 1, 2);
select * from agg_t order by k1;
insert into agg_t values (1, 0, 3, 0, 5, 5), (2, 0, 1, 0, 10, 10);
select * from agg_t order by k1;
select k1, k2, v1, v2 from agg_t where k1 in (1, 2) order by k1;

-- Add key column without specifying position
alter table agg_t add column k5 int default '0';
function: wait_alter_table_finish()
select * from agg_t order by k1;
insert into agg_t values (6, 3, 110, 120, 1, 2, 3);
select * from agg_t order by k1;
insert into agg_t values (1, 0, 3, 0, 0, 5, 5), (2, 0, 1, 0, 0, 10, 10);
select * from agg_t order by k1;
select k1, k2, v1, v2 from agg_t where k1 in (1, 2) order by k1;

-- Explicit reorder via ALTER TABLE ORDER BY
alter table agg_t order by (k1, k4, k5, k2, k3);
function: wait_alter_table_finish()
select * from agg_t order by k1;
insert into agg_t values (7, 1, 130, 140, 1, 2, 3);
select * from agg_t order by k1;
insert into agg_t values (1, 0, 3, 0, 0, 5, 5), (2, 0, 1, 0, 0, 10, 10);
select * from agg_t order by k1;
select k1, k2, v1, v2 from agg_t where k1 in (1, 2) order by k1;

-- Add key column after reorder
alter table agg_t add column k6 int default '0';
function: wait_alter_table_finish()
select * from agg_t order by k1;
insert into agg_t values (8, 2, 4, 1, 2, 4, 150, 160);
select * from agg_t order by k1;
insert into agg_t values (1, 0, 3, 0, 0, 0, 5, 5), (2, 0, 1, 0, 0, 0, 10, 10);
select * from agg_t order by k1;
select k1, k2, v1, v2 from agg_t where k1 in (1, 2) order by k1;

drop database test_agg_add_key_sort_${uuid0} force;
