-- name: test_file_sink_commit_failed @sequential
set pipeline_dop = 1;
-- result:
-- !result
set pipeline_sink_dop = 1;
-- result:
-- !result
admin enable failpoint 'parquet_writer_close_failed';
-- result:
-- !result
create table t1(c1 int, c2 array<array<string>>) duplicate key(c1) distributed by hash(c1) buckets 1 properties("replication_num"="1");
-- result:
-- !result
insert into t1 values (1, [["aa", "bb"],["ccc"]]);
-- result:
-- !result
insert into files(
    "path" = "s3://${oss_bucket}/test_sink/test_file_sink_commit_failed/${uuid0}/",
    "format" = "parquet",
    "aws.s3.endpoint" = "${oss_endpoint}",
    "aws.s3.access_key" = "${oss_ak}",
    "aws.s3.secret_key" = "${oss_sk}") select * from t1;
-- result:
[REGEX].*writer close failed by fail point.*
-- !result
admin disable failpoint 'parquet_writer_close_failed';
-- result:
-- !result
admin enable failpoint 'parquet_writer_throw_exception';
-- result:
-- !result
insert into files(
    "path" = "s3://${oss_bucket}/test_sink/test_file_sink_commit_failed/${uuid0}/",
    "format" = "parquet",
    "aws.s3.endpoint" = "${oss_endpoint}",
    "aws.s3.access_key" = "${oss_ak}",
    "aws.s3.secret_key" = "${oss_sk}") select * from t1;
-- result:
[REGEX].*close file error: Parquet writer throws exception by fail point.*
-- !result
admin disable failpoint 'parquet_writer_throw_exception';
-- result:
-- !result
shell: ossutil64 rm -rf oss://${oss_bucket}/test_sink/test_file_sink_commit_failed/${uuid0} >/dev/null || echo "exit 0" >/dev/null
-- result:
0

-- !result
CLEANUP {
    admin disable failpoint 'parquet_writer_close_failed';
} END CLEANUP