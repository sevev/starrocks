-- name: test_insert_into_merged_partition
create database test_merge_insert_${uuid0};
use test_merge_insert_${uuid0};

create table t(k datetime, v int) partition by date_trunc('month', k) distributed by hash(k) buckets 3 properties("replication_num"="1");

insert into t values ('2022-03-01', 1),('2022-06-15', 2),('2022-09-20', 3),('2023-01-10', 4),('2023-05-05', 5);
select * from t order by k;
show partitions from t;

alter table t partition by date_trunc('year', k) between '2022-01-01' and '2022-12-31';
function: wait_optimize_table_finish()
show partitions from t;

insert into t values ('2022-04-01', 6),('2022-11-11', 7);
select * from t order by k;

insert into t values ('2023-02-14', 8),('2022-07-07', 9),('2024-01-01', 10);
select * from t order by k;
show partitions from t;

drop database test_merge_insert_${uuid0};

-- name: test_insert_into_merged_partition_low_open_partitions
create database test_merge_low_${uuid0};
use test_merge_low_${uuid0};

admin set frontend config ("max_load_initial_open_partition_number"="1");

create table t(k datetime, v int) partition by date_trunc('month', k) distributed by hash(k) buckets 3 properties("replication_num"="1");

insert into t values ('2022-03-01', 1),('2022-06-15', 2),('2023-01-10', 3);
select * from t order by k;

alter table t partition by date_trunc('year', k) between '2022-01-01' and '2022-12-31';
function: wait_optimize_table_finish()
show partitions from t;

insert into t values ('2022-04-01', 4),('2022-09-01', 5),('2023-02-01', 6),('2024-01-01', 7);
select * from t order by k;

insert into t values ('2022-01-15', 8),('2022-12-25', 9),('2022-06-30', 10),('2023-06-01', 11);
select * from t order by k;
show partitions from t;

admin set frontend config ("max_load_initial_open_partition_number"="64");

drop database test_merge_low_${uuid0};

-- name: test_insert_into_multi_year_merged_partitions
create database test_merge_multi_${uuid0};
use test_merge_multi_${uuid0};

admin set frontend config ("max_load_initial_open_partition_number"="1");

create table t(k datetime, v int) partition by date_trunc('month', k) distributed by hash(k) buckets 3 properties("replication_num"="1");

insert into t values ('2020-05-01',1),('2021-05-01',2),('2022-05-01',3),('2023-05-01',4);

alter table t partition by date_trunc('year', k) between '2020-01-01' and '2022-12-31';
function: wait_optimize_table_finish()
show partitions from t;

insert into t values ('2020-01-15',5),('2020-11-20',6),('2021-03-10',7),('2021-09-25',8),('2022-02-14',9),('2022-12-31',10),('2023-07-04',11);
select * from t order by k;
show partitions from t;

admin set frontend config ("max_load_initial_open_partition_number"="64");

drop database test_merge_multi_${uuid0};
