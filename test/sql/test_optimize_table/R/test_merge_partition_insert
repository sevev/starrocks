-- name: test_insert_into_merged_partition
create database test_merge_insert_${uuid0};
-- result:
-- !result
use test_merge_insert_${uuid0};
-- result:
-- !result
create table t(k datetime, v int) partition by date_trunc('month', k) distributed by hash(k) buckets 3 properties("replication_num"="1");
-- result:
-- !result
insert into t values ('2022-03-01', 1),('2022-06-15', 2),('2022-09-20', 3),('2023-01-10', 4),('2023-05-05', 5);
-- result:
-- !result
select * from t order by k;
-- result:
2022-03-01 00:00:00	1
2022-06-15 00:00:00	2
2022-09-20 00:00:00	3
2023-01-10 00:00:00	4
2023-05-05 00:00:00	5
-- !result
show partitions from t;
-- result:
[REGEX].*p202203.*
.*p202206.*
.*p202209.*
.*p202301.*
.*p202305.*
-- !result
alter table t partition by date_trunc('year', k) between '2022-01-01' and '2022-12-31';
-- result:
-- !result
function: wait_optimize_table_finish()
-- result:
None
-- !result
show partitions from t;
-- result:
[REGEX].*p2022.*
.*p202301.*
.*p202305.*
-- !result
insert into t values ('2022-04-01', 6),('2022-11-11', 7);
-- result:
-- !result
select * from t order by k;
-- result:
2022-03-01 00:00:00	1
2022-04-01 00:00:00	6
2022-06-15 00:00:00	2
2022-09-20 00:00:00	3
2022-11-11 00:00:00	7
2023-01-10 00:00:00	4
2023-05-05 00:00:00	5
-- !result
insert into t values ('2023-02-14', 8),('2022-07-07', 9),('2024-01-01', 10);
-- result:
-- !result
select * from t order by k;
-- result:
2022-03-01 00:00:00	1
2022-04-01 00:00:00	6
2022-06-15 00:00:00	2
2022-07-07 00:00:00	9
2022-09-20 00:00:00	3
2022-11-11 00:00:00	7
2023-01-10 00:00:00	4
2023-02-14 00:00:00	8
2023-05-05 00:00:00	5
2024-01-01 00:00:00	10
-- !result
show partitions from t;
-- result:
[REGEX].*p2022.*
.*p202301.*
.*p202302.*
.*p202305.*
.*p202401.*
-- !result
drop database test_merge_insert_${uuid0};
-- result:
-- !result
-- name: test_insert_into_merged_partition_low_open_partitions
create database test_merge_low_${uuid0};
-- result:
-- !result
use test_merge_low_${uuid0};
-- result:
-- !result
admin set frontend config ("max_load_initial_open_partition_number"="1");
-- result:
-- !result
create table t(k datetime, v int) partition by date_trunc('month', k) distributed by hash(k) buckets 3 properties("replication_num"="1");
-- result:
-- !result
insert into t values ('2022-03-01', 1),('2022-06-15', 2),('2023-01-10', 3);
-- result:
-- !result
select * from t order by k;
-- result:
2022-03-01 00:00:00	1
2022-06-15 00:00:00	2
2023-01-10 00:00:00	3
-- !result
alter table t partition by date_trunc('year', k) between '2022-01-01' and '2022-12-31';
-- result:
-- !result
function: wait_optimize_table_finish()
-- result:
None
-- !result
show partitions from t;
-- result:
[REGEX].*p2022.*
.*p202301.*
-- !result
insert into t values ('2022-04-01', 4),('2022-09-01', 5),('2023-02-01', 6),('2024-01-01', 7);
-- result:
-- !result
select * from t order by k;
-- result:
2022-03-01 00:00:00	1
2022-04-01 00:00:00	4
2022-06-15 00:00:00	2
2022-09-01 00:00:00	5
2023-01-10 00:00:00	3
2023-02-01 00:00:00	6
2024-01-01 00:00:00	7
-- !result
insert into t values ('2022-01-15', 8),('2022-12-25', 9),('2022-06-30', 10),('2023-06-01', 11);
-- result:
-- !result
select * from t order by k;
-- result:
2022-01-15 00:00:00	8
2022-03-01 00:00:00	1
2022-04-01 00:00:00	4
2022-06-15 00:00:00	2
2022-06-30 00:00:00	10
2022-09-01 00:00:00	5
2022-12-25 00:00:00	9
2023-01-10 00:00:00	3
2023-02-01 00:00:00	6
2023-06-01 00:00:00	11
2024-01-01 00:00:00	7
-- !result
show partitions from t;
-- result:
[REGEX].*p2022.*
.*p202301.*
.*p202302.*
.*p202306.*
.*p202401.*
-- !result
admin set frontend config ("max_load_initial_open_partition_number"="64");
-- result:
-- !result
drop database test_merge_low_${uuid0};
-- result:
-- !result
-- name: test_insert_into_multi_year_merged_partitions
create database test_merge_multi_${uuid0};
-- result:
-- !result
use test_merge_multi_${uuid0};
-- result:
-- !result
admin set frontend config ("max_load_initial_open_partition_number"="1");
-- result:
-- !result
create table t(k datetime, v int) partition by date_trunc('month', k) distributed by hash(k) buckets 3 properties("replication_num"="1");
-- result:
-- !result
insert into t values ('2020-05-01',1),('2021-05-01',2),('2022-05-01',3),('2023-05-01',4);
-- result:
-- !result
alter table t partition by date_trunc('year', k) between '2020-01-01' and '2022-12-31';
-- result:
-- !result
function: wait_optimize_table_finish()
-- result:
None
-- !result
show partitions from t;
-- result:
[REGEX].*p2020.*
.*p2021.*
.*p2022.*
.*p202305.*
-- !result
insert into t values ('2020-01-15',5),('2020-11-20',6),('2021-03-10',7),('2021-09-25',8),('2022-02-14',9),('2022-12-31',10),('2023-07-04',11);
-- result:
-- !result
select * from t order by k;
-- result:
2020-01-15 00:00:00	5
2020-05-01 00:00:00	1
2020-11-20 00:00:00	6
2021-03-10 00:00:00	7
2021-05-01 00:00:00	2
2021-09-25 00:00:00	8
2022-02-14 00:00:00	9
2022-05-01 00:00:00	3
2022-12-31 00:00:00	10
2023-05-01 00:00:00	4
2023-07-04 00:00:00	11
-- !result
show partitions from t;
-- result:
[REGEX].*p2020.*
.*p2021.*
.*p2022.*
.*p202305.*
.*p202307.*
-- !result
admin set frontend config ("max_load_initial_open_partition_number"="64");
-- result:
-- !result
drop database test_merge_multi_${uuid0};
-- result:
-- !result
